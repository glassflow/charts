{{- $host := include "postgresql.host" . }}
{{- $port := .Values.service.port | default 5432 | int }}
{{- $database := .Values.auth.database | default "glassflow" }}
{{- $usingExistingSecret := and .Values.auth.existingSecret.enabled .Values.auth.existingSecret.name }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "postgresql.fullname" . }}-connection
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "postgresql.labels" . | nindent 4 }}
type: Opaque
data:
  # Connection information (always created)
  host: {{ $host | b64enc | quote }}
  port: {{ $port | toString | b64enc | quote }}
  database: {{ $database | b64enc | quote }}
  # Connection URL template (without password for security)
  # Format: postgresql://username:password@host:port/database
  connection-url-template: {{ printf "postgresql://%s:%d/%s" $host $port $database | b64enc | quote }}
{{- if not $usingExistingSecret }}
{{- $userPassword := .Values.auth.password }}
{{- if not $userPassword }}
{{- $userPassword = randAlphaNum 16 }}
{{- end }}
{{- $username := .Values.auth.username }}
{{- if not $username }}
{{- $username = printf "pguser_%s" (randAlphaNum 8) }}
{{- end }}
{{- $connectionUrl := printf "postgresql://%s:%s@%s:%d/%s" $username $userPassword $host $port $database }}
  # Credentials (only created when not using existing secret)
  username: {{ $username | b64enc | quote }}
  password: {{ $userPassword | b64enc | quote }}
  connection-url: {{ $connectionUrl | b64enc | quote }}
{{- end }}

